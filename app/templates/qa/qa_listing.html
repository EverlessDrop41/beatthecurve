{% set active = "forum" %}
{% extends 'class_layout.html' %}
{% from 'macros.html' import render_lesson_tabs, render_field, render_semester_tabs %}
{% block title %}{{ lesson.lesson_name }}{% endblock %}
{% block page %}
<div class="row">
  <div class="col s2">
    {% if semesters|length > 0 %}
      {{ render_semester_tabs(semesters, semester_enum) }}
    {% else %}
      <h5>No Questions Found</h5>
    {% endif %}
  </div>
  <div class="col s10">
    <div class="card-panel">
        <h3 class="content_title">Add a Question</h3>
        <form method="post" action="{{ url_for("qa_bp.add_question", lessonid=lesson.id) }}">
            {{ form.csrf_token() }}
            <div class="input-field">
                {%for error in form.document.errors %}
                    <div class="red-text">{{ error }}</div>
                {% endfor %}
                <strong><h6 class="grey-text text-darken-1">Subject</h6></strong>
                {{ form.document(class_="blue_field") }}
            </div>
            <div class="input-field">
                {%for error in form.name.errors %}
                    <div class="red-text">{{ error }}</div>
                {% endfor %}
                <strong><h6 class="grey-text text-darken-1">Question</h6></strong>
                {{ form.name(class_="blue_field") }}
            </div>
            <div class="input-field">
                {% for error in form.content.errors %}
                    <div class="red-text">{{ error }}</div>
                {% endfor %}
                <strong><h6 class="grey-text text-darken-1">Content</h6></strong>
                {{ form.content(class_="materialize-textarea q_reply") }}
            </div>
          <div class="row">
            <button type="submit" class="waves-effect waves-light btn col s2 push-s5 lowercase">send</button>
          </div>
        </form>
    </div>
  <div id="questions_list">
      <span v-for="q in questions">
    {% raw %}
    <br>
      <div class="card-panel question" q_id="{{ q.id }}" semester="{{ q.semester }}" year="{{ q.year }}" >
          <div class="row">
              <div class="col s1 valign-wrapper">
                      <a href="#!" v-bind:class="{ 'primary': q.has_voted, 'grey-text-imp': !q.has_voted }" class="primary valign q_vote" question="{{ q.id }}"><i class="fa fa-thumbs-up fa-lg"></i> <span id="votes_{{ q.id }}">{{ q.votes}}</span></a>
              </div>
              <div class="col s10">
                  <div class="q_head" q_id={{ q.id }}>
                    <div class="row">
                        <i class="fa fa-user fa-lg primary"></i>
                      <span class="primary poster_name">{{q.user }}</span>
                      <span class="lightBlue right q_document">{{q.document}}</span>
                    </div>
                    <div class="row no_bot" id="q_title_{{ q.id }}">
                      <h5 class="grey-text q_question">{{q.question}}</h5>
                    </div>
                  </div>
                  <div class="q_body" id="q_body_{{ q.id }}">
                    <div class="row">
                      <p>{{q.details}}</p>
                    </div>
                    <div class="divider bg-primary"></div>
                      <span v-for="reply in q.replies"><div class="comment">
                        <div class="row comment_name primary">
                                  <a v-bind:class="{ 'primary': q.has_voted, 'grey-text-imp': !q.has_voted }" href="#!" class="primary valign r_vote" reply="{{ $key }}"><i class="fa fa-thumbs-up fa-lg"></i> <span id="votes_{{ $key }}">{{ reply.votes}}</span></a>
                            &nbsp;<i class="fa fa-user fa-lg"></i>&nbsp;{{ reply.user }}
                            <span class="lightBlue right">{{reply.datetime}}</span>
                        </div>
                        <p class="grey-text" style="margin-left: 42px;">{{ reply.content }}</p>
                      </div>
                        <div v-if="$index == q.replies.length - 1" class="divider bg-primary"></div>
                        <div v-else class="divider light-grey"></div>
                      </span>
                    <form class=""method="post" action="/qa/reply/{{ q.id }}">
                        <input id="csrf_token" name="csrf_token" placeholder="Csrf Token" type="hidden" value="{{ csrf_token }}">
                        <div class="input-field">
                          <strong><h6 class="grey-text">Type a reply</h6></strong>
                          <textarea class="q_reply materialize-textarea" id="reply-content-{{ q.id }}" name="content"></textarea>
                        </div>
                      <div class="row">
                        <button type="submit" class="waves-effect waves-light btn center right lowercase">send</button>
                      </div>
                    </form>
                  </div>
              </div>
          </div>

      </div>
    {% endraw %}
      </span>
      <i v-if="is_loading" class="fa fa-circle-o-notch fa-5x fa-spin primary center"></i>
  </div>
</div>
</div>
{% endblock %}
{% block js %}
{{super()}}
    <script>
        function setupQuestions() {
            $(".q_body").hide();
            $(".q_head").click(function (e) {
                q_id = $(this).attr("q_id");
                bodyIdStr = "#q_body_" + q_id;
                console.log(bodyIdStr);
                $(bodyIdStr).slideToggle();
            });
            $("#q_body_" + $(".question[first]").attr("q_id")).show();
            $(".q_vote").click(function () {
                var elem = $(this);
                var id = $(this).attr("question");
                $.post("/qa/question-vote", {question_id: id}, function (data) {
                    if (data.success) {
                        console.log(data);
                        console.log(elem.hasClass("primary"));
                        console.log(elem.hasClass("grey-text-imp"));
                        if (elem.hasClass("primary")) {
                            elem.removeClass("primary");
                            elem.addClass("grey-text-imp");
                        }else if (elem.hasClass("grey-text-imp")) {
                            elem.removeClass("grey-text-imp");
                            elem.addClass("primary");
                        }

                        $("#votes_" + id).text(data.number_of_posts);
                    } else {
                        alert("Error upvoting");
                    }

                });
            });

            $(".r_vote").click(function () {
                var elem = $(this);
                var id = $(this).attr("reply");
                $.post("/qa/reply-vote", {reply_id: id}, function (data) {
                    if (data.success) {
                        console.log(data);
                        console.log(elem.hasClass("primary"));
                        console.log(elem.hasClass("grey-text-imp"));
                        if (elem.hasClass("primary")) {
                            elem.removeClass("primary");
                            elem.addClass("grey-text-imp");
                        }else if (elem.hasClass("grey-text-imp")) {
                            elem.removeClass("grey-text-imp");
                            elem.addClass("primary");
                        }

                        $("#votes_" + id).text(data.number_of_posts);
                    } else {
                        alert("Error upvoting");
                    }

                });
            });
        }

        var q_vue = new Vue({
            el: "#questions_list",
            data: {
                csrf_token: '',
                questions: {},
                is_loading: true,
                moreToLoad: true
            }
        });

        $(document).ready(function () {
            q_vue.csrf_token = $("#csrf_token").val();
            setupQuestions();
            loadQuestions();
        });

        function loadQuestions(q_ids) {
            q_vue.is_loading = true;
            $.post("/qa/get-questions",
                    {
                        question_ids: q_ids,
                        lesson_id: '1'
                    },
                    function (data) {
                        if (data.success) {
                            console.log(data);
                            //Add questions to vue
                            q_vue.$set('questions', $.extend($.extend({}, q_vue.questions), data.questions));
                            setupQuestions();
                            q_vue.is_loading = false;
                            q_vue.moreToLoad = data.moreToLoad;
                        } else {
                            q_vue.is_loading = false;
                            alert("Error loading more Questions");
                        }
                    }
            );
        }

    </script>
 {# <script src="{{ url_for("static", filename="js/get_discussions.js") }}"></script>
  <script>
    $().ready(
      function () {
        $("#discussion").prop('disabled', true);
        $('select').material_select();

        if ($("#lecture").val() !== "-1") {
          getDiscussions($("#lecture").val(), {}, addQuestionDiscussionSelectFieldUpdate);

        }
        $("#lecture").change(function () {
          if ($("#lecture").val() !== "-1") {
              getDiscussions($("#lecture").val(), {}, addQuestionDiscussionSelectFieldUpdate);
          } else {
            $("#discussion").prop('disabled', true);
            $("#discussion").empty();
            $('select').material_select();

          }

        });
        var active = $('.semester-tab.active');
        var year = $(active).attr('year');
        var semester = $(active).attr('semester');
        $('.question').hide();
        $('.question[year="' + year + '"][semester="' + semester + '"]').show();
        $('.semester-tab').click(
          function (e) {
            var year = $(this).attr('year');
            var semester = $(this).attr('semester');
            $('.question').hide();
            $('.question[year="' + year + '"][semester="' + semester + '"]').show();
          }
        );
      }
    )
  </script> #}
{% endblock %}
